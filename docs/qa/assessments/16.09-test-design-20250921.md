# Test Design: Story 16.09 — Gateway JWT Validation (Envoy)

Date: 2025-09-21
Designer: Quinn (Test Architect)

## Test Strategy Overview
- Total test scenarios: 16
- e2e tests: 14 (88%)
- Integration/unit: 2 (12%) — config lint/manifest schema
- Priority distribution: P0: 9, P1: 5, P2: 2

Rationale: Security posture must be validated at the edge with end-to-end flows exercising the gateway policy. Minimal unit/integration tests ensure manifests are sane and linted.

## Scenarios by Acceptance Criteria

### AC1: JWT provider + manifests
- 16.09-CONF-001 (Unit, P1) – Manifests pass schema/validate (GatewayClass, Gateway, HTTPRoute, JWT ext)
- 16.09-CONF-002 (Unit, P1) – Env substitution present for `OIDC_ISSUER`, `SECURITY_JWT_EXPECTED_AUDIENCE`, `JWKS_CACHE_TTL_SECONDS`

### AC2: Protected APIs via HTTPRoute
- 16.09-E2E-001 (P0) – `/api/**` requires JWT
- 16.09-E2E-002 (P0) – `/actuator/health` reachable without auth

### AC3: Header sanitation/propagation
- 16.09-E2E-003 (P0) – On invalid token, gateway strips `Authorization` and returns 401
- 16.09-E2E-004 (P0) – On valid token, backend receives `x-auth-sub`/`x-auth-roles` only

### AC4: Callback restrictions
- 16.09-E2E-005 (P0) – Only callbacks from configured hosts pass to frontend
- 16.09-E2E-006 (P1) – Non-listed hosts are blocked (403)

### AC5: Rate limiting (baseline)
- 16.09-E2E-007 (P1) – `/api/auth/*` requests limited to default 60/min per token
- 16.09-E2E-008 (P1) – Limit changes with env `GATEWAY_RATE_LIMIT_PER_TOKEN`

### AC6: TLS/mTLS
- 16.09-E2E-009 (P2) – TLS termination established; valid certificate served
- 16.09-E2E-010 (P2) – mTLS doc reviewed (no test if not enabled)

### AC7: Documentation
- 16.09-CONF-003 (P1) – Docs updated in `docs/architecture/gateway-envoy.md`; manifests present under `infra/gateway/`

### AC8: Validation / outage behavior
- 16.09-E2E-011 (P0) – Valid JWT → 200 from `/api/whoami`
- 16.09-E2E-012 (P0) – Expired/wrong audience → 401
- 16.09-E2E-013 (P0) – IdP/JWKS outage → 5xx, error documented

## Recommended Execution Order
1) P0 e2e: 001–006, 011–013
2) P1: 007–008, CONF-001/003
3) P2: 009–010

## Gate Snippet
```yaml
test_design:
  scenarios_total: 16
  by_level:
    e2e: 14
    unit_integration: 2
  by_priority:
    p0: 9
    p1: 5
    p2: 2
  coverage_gaps: []
```

## Trace References
- Story: docs/stories/backend/epic-16/09-gateway-jwt-validation-envoy.md
- Architecture: docs/architecture/gateway-envoy.md

