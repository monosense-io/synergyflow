## Risk Profile: Story 16.08 — Backend OAuth2 Resource Server (JWT)

Date: 2025-09-20
Reviewer: Quinn (Test Architect)

## Executive Summary
- Total Risks Identified: 12
- Critical Risks: 1
- High Risks: 5
- Medium Risks: 4
- Low Risks: 2
- Risk Score: 44/100 (normalized)

## Highest Risks

### 1) SEC-101: Incorrect JWT validation (issuer/audience)
Score: 9 (Critical)
Probability: Medium — Misconfigured issuers/audiences are common.
Impact: Critical — Can allow unauthorized access or block all traffic.
Mitigation:
- Enforce exact `issuer` and required `audience` via validators.
- Fail closed on validation errors; monitor with clear metrics.
Testing Focus:
- Integration tests for wrong issuer/audience → 401; correct values → 200.

### 2) SEC-102: Role/claim mapping errors (privilege escalation or lockout)
Score: 6 (High)
Probability: Medium — IdP claim shapes vary (Keycloak/Auth0/Okta).
Impact: High — Admin routes exposed or legitimate access denied.
Mitigation:
- Central converter for roles/permissions with normalization rules.
- Unit tests for multiple claim shapes (realm roles, permissions, roles).
Testing Focus:
- Converter tests; 403 on admin without role; 200 with role.

### 3) OPS-101: JWKS unavailability/key rotation outages
Score: 6 (High)
Probability: Medium — Network issues/rotations happen.
Impact: High — All requests start failing with 401.
Mitigation:
- Reasonable JWKS cache TTL and retry/backoff; surface health metrics.
- Document key rotation playbook; alarms on surge in 401s.
Testing Focus:
- Simulate JWKS fetch failure → degraded but observable state.

## Risk Distribution

### By Category
- Security: 6 (Critical: 1, High: 2)
- Operational: 3 (High: 1)
- Data: 1 (Medium: 1)
- Technical: 2 (Medium: 1, Low: 1)

### By Component
- Resource Server config: 7
- Role mapping: 2
- Observability/operations: 3

## Detailed Risk Register

| Risk ID  | Description                                                             | Probability | Impact | Score | Priority |
|----------|-------------------------------------------------------------------------|-------------|--------|-------|----------|
| SEC-101  | Issuer/audience misvalidation                                           | Medium (3)  | Critical (3) | 9 | Critical |
| SEC-102  | Role/claim mapping errors (esc/lockout)                                 | Medium (2)  | High (3)     | 6 | High     |
| SEC-103  | Algorithm confusion (alg="none", HS/RS mismatch)                       | Low (1)     | High (3)     | 3 | Medium   |
| SEC-104  | Overly broad CORS exposing APIs                                         | Medium (2)  | Medium (2)   | 4 | Medium   |
| OPS-101  | JWKS unavailability / key rotation outage                               | Medium (2)  | High (3)     | 6 | High     |
| OPS-102  | Clock skew causes intermittent auth failures                            | Medium (2)  | Medium (2)   | 4 | Medium   |
| OPS-103  | Lack of auth metrics/alerts (silent failures)                           | Medium (2)  | Medium (2)   | 4 | Medium   |
| DATA-101 | Logging sensitive token data (claims, secrets)                          | Low (1)     | High (3)     | 3 | Medium   |
| TECH-101 | Security dependencies outdated / CVEs                                   | Medium (2)  | Medium (2)   | 4 | Medium   |
| TECH-102 | Test fragility generating/validating JWTs                               | Medium (2)  | Low (1)      | 2 | Low      |
| PERF-101 | JWT validation overhead under load                                      | Low (1)     | Medium (2)   | 2 | Low      |
| BUS-101  | Backend/gateway policy mismatch (double-validation, header conflicts)   | Medium (2)  | Medium (2)   | 4 | Medium   |

## Risk-Based Testing Strategy

### Priority 1 (Critical/High)
- Validation correctness: issuer/audience strict checks (positive/negative cases).
- Role mapping converter: claim-shape matrix (Keycloak realm roles, Auth0 permissions, Okta roles).
- JWKS failure modes & key rotation: caching, retry/backoff, alert on 401 spikes.

### Priority 2 (Medium)
- CORS policy: restrict origins/enabled methods/headers for dev/staging only.
- Clock skew tolerance: boundary tests around exp/nbf.
- Auth observability: counters for 2xx/401/403 by reason; dashboards/alerts.

### Priority 3 (Low)
- Performance: micro-benchmark JWT decode path; verify negligible overhead.
- Dependency health: pin security libs; run vulnerability scan in CI.

## Risk Acceptance Criteria

Must Fix before enabling protected APIs in staging:
- SEC-101 (issuer/audience validation)
- SEC-102 (role mapping correctness)
- OPS-101 (JWKS cache/retry + rotation playbook)

Monitor:
- CORS scope, clock skew tuning, dependency CVEs, gateway/backend policy alignment.

---

```yaml
# risk_summary (paste into gate file when created for this story):
risk_summary:
  totals:
    critical: 1
    high: 5
    medium: 4
    low: 2
  highest:
    id: SEC-101
    score: 9
    title: 'Incorrect JWT validation (issuer/audience)'
  recommendations:
    must_fix:
      - 'Enforce strict issuer + audience validation with explicit validators'
      - 'Centralize and test role/permission claim mapping; deny by default'
      - 'Configure JWKS caching + retry; add rotation runbook and alerts'
    monitor:
      - 'Tighten CORS in non-prod; review logs for PII; pin security deps'
      - 'Add auth metrics dashboards; watch 401/403 trends and error reasons'
```

