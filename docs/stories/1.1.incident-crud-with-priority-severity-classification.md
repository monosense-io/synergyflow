# Story 1.1: Incident CRUD with Priority/Severity Classification

## Status

Draft

## Story

**As a** Service Desk Agent,
**I want** to create, view, and update incidents with defined priority and severity classification,
**so that** issues can be triaged and tracked accurately from creation through resolution.

## Acceptance Criteria

1. Incident CRUD functional with all fields (title, description, priority, severity, assigned_to, status)
2. SLA timers fire within ±5 seconds (p95) of configured deadline
3. Incident lifecycle transitions publish events via ApplicationEventPublisher
4. Events stored in event_publication table and delivered to consumers within 100ms (p95)
5. Comments and attachments stored with incident relationship
6. Audit log captures all incident lifecycle changes with user, timestamp, and field-level changes
7. SLA pre-breach notifications sent at 80% threshold with auto-escalation at 100%
8. Auto-routing assigns incidents based on category/priority rules with manual override capability
9. Problem records created with multi-incident linking and root cause analysis tracking
10. KEDB integration enables known error matching and solution suggestions
11. Trend reporting identifies recurring issues with pattern detection and analytics

Source: docs/prd/epics/02-foundation-phase-epics-months-1-4.md (Epic-01: Incident and Problem Management)

## Tasks / Subtasks

- [ ] Backend: Implement Incident module CRUD (AC: 1)
  - [ ] Define JPA Entity `Incident` with fields, enums (Priority, Severity, Status), auditing, optimistic locking. [Source: docs/architecture/11-backend-architecture.md#jpa-entity-example; docs/architecture/4-data-models.md#4.1-incident; docs/architecture/9-database-schema.md#9.2-core-tables]
  - [ ] Create DTOs `CreateIncidentRequest`, `UpdateIncidentRequest`, `IncidentResponse` using Lombok; map via MapStruct. [Source: docs/architecture/11-backend-architecture.md#controller-template-rest-api; docs/architecture/16-coding-standards.md#16.2-java-tooling-mandatory-lombok-mapstruct; docs/architecture/33-mandatory-backend-code-templates-conventions.md]
  - [ ] Implement `IncidentRepository` queries for filters, pagination. [Source: docs/architecture/11-backend-architecture.md#data-access-layer-spring-data-jpa]
  - [ ] Implement `IncidentService` create/get/list/update logic without event publication in this story (events covered by later story). [Source: docs/architecture/11-backend-architecture.md#service-layer-with-event-publishing]
  - [ ] Implement `IncidentController` endpoints: `POST /api/v1/incidents`, `GET /api/v1/incidents`, `GET /api/v1/incidents/{id}`, `PATCH /api/v1/incidents/{id}`; validate fields per OpenAPI. [Source: docs/architecture/5-api-specification.md#incident-management-endpoints]
- [ ] Database: Add Flyway migration for `synergyflow_incidents.incidents` table (no deletes; soft-delete not in scope). [Source: docs/architecture/9-database-schema.md#9.2-core-tables]
- [ ] Security: Enforce JWT auth on endpoints via Spring Security Resource Server. [Source: docs/architecture/11-backend-architecture.md#security-configuration]
- [ ] Validation: Apply constraints (title min/max, enums, required fields) per OpenAPI schema. [Source: docs/architecture/5-api-specification.md#components]
- [ ] Testing: Unit + integration tests for CRUD
  - [ ] Unit test `IncidentService` create/update with Mockito verifying persistence (event publishing deferred). [Source: docs/architecture/14-testing-strategy.md#backend-testing]
  - [ ] Web layer test `IncidentController` with `@WebMvcTest` for validation and status codes. [Source: docs/architecture/16-coding-standards.md#16.3-testing-standards]
  - [ ] Integration test with Testcontainers PostgreSQL to persist/read Incident. [Source: docs/architecture/14-testing-strategy.md#integration-test-spring-modulith--testcontainers]
- [ ] Project Structure: Place code under `backend/src/main/java/io/monosense/synergyflow/incident` with `.internal` subpackage for entity/repo/impl; public DTOs/services at module root. [Source: docs/architecture/2-high-level-architecture.md; docs/architecture/16-coding-standards.md#package-boundary-enforcement-spring-modulith]
- [ ] Out of Scope notes for this story (tracked by later stories): SLA timers (AC: 2,7), event publication (AC: 3,4), comments/attachments (AC: 5), audit logging (AC: 6), auto-routing (AC: 8), problem/KEDB/trend reporting (AC: 9-11).

## Dev Notes

- Previous Story Insights
  - No previous stories exist (this is 1.1). N/A.

- Data Models
  - Incident fields and enums as defined in architecture docs. Ensure canonical UUID `id`, audit timestamps, and `version` for optimistic locking. [Source: docs/architecture/4-data-models.md#4.1-incident]
  - Database schema for `synergyflow_incidents.incidents` table with indexes and checks; implement via Flyway migration. [Source: docs/architecture/9-database-schema.md#9.2-core-tables]

- API Specifications
  - Endpoints to implement now: `POST /incidents`, `GET /incidents`, `GET /incidents/{id}`, `PATCH /incidents/{id}` (scoped to CRUD). [Source: docs/architecture/5-api-specification.md#incident-management-endpoints]
  - Required validation constraints (title min/max, enum values). [Source: docs/architecture/5-api-specification.md#components]
  - Note: Delete endpoint not defined in API spec; do not implement DELETE. Freshness badge field appears in list/detail responses; integrate with projection lag in later stories (Epic-00). [Source: docs/architecture/5-api-specification.md]

- Component Specifications (Backend)
  - Module path and package structure per Spring Modulith with `.internal` boundaries. [Source: docs/architecture/2-high-level-architecture.md; docs/architecture/16-coding-standards.md#package-boundary-enforcement-spring-modulith]
  - Controller/Service/Repository templates provided; adapt without event publishing in this story. [Source: docs/architecture/11-backend-architecture.md#controller-template-rest-api; #data-access-layer-spring-data-jpa]

- File Locations
  - Backend code: `backend/src/main/java/io/monosense/synergyflow/incident/...` [Source: docs/architecture/2-high-level-architecture.md]
  - Flyway migrations: `backend/src/main/resources/db/migration/V0001__create_incidents.sql` [Source: docs/architecture/2-high-level-architecture.md]

- Technical Constraints
  - Lombok + MapStruct mandatory; DTOs immutable; repositories via Spring Data JPA; no entity leakage in REST. [Source: docs/architecture/16-coding-standards.md#16.2-java-tooling-mandatory-lombok-mapstruct]
  - Package naming must start with `io.monosense.synergyflow.*`. [Source: docs/architecture/16-coding-standards.md#16.1-critical-fullstack-rules]
  - Tests must use Testcontainers PostgreSQL (no H2). [Source: docs/architecture/16-coding-standards.md#database-testing---mandatory-testcontainers]

### Testing

- Required
  - Backend unit tests for service layer CRUD. [Source: docs/architecture/14-testing-strategy.md#backend-testing]
  - Controller tests with `@WebMvcTest` for validation and status codes. [Source: docs/architecture/16-coding-standards.md#16.3-testing-standards]
  - Integration test with Testcontainers PostgreSQL covering create → fetch → update flow. [Source: docs/architecture/14-testing-strategy.md#integration-test-spring-modulith--testcontainers]
- Coverage targets: Backend unit ≥80%. [Source: docs/architecture/14-testing-strategy.md#14.1-testing-pyramid]

## Change Log

| Date       | Version | Description                                      | Author |
|------------|---------|--------------------------------------------------|--------|
| 2025-10-18 | v0.1    | Initial draft created via Scrum Master task     | Bob    |

## Dev Agent Record

- Agent Model Used: 
- Debug Log References: 
- Completion Notes List: 
- File List: 

## QA Results

- Pending QA review.

