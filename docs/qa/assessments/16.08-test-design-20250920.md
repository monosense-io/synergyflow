# Test Design: Story 16.08 — Backend OAuth2 Resource Server (JWT)

Date: 2025-09-20
Designer: Quinn (Test Architect)

## Test Strategy Overview
- Total test scenarios: 18
- Unit tests: 6 (33%)
- Integration tests: 12 (67%)
- E2E tests: 0 (0%) — not required for this story; covered by integration
- Priority distribution: P0: 10, P1: 6, P2: 2

Rationale: Security-sensitive behavior (JWT validation, role mapping, route protection) demands strong integration coverage with targeted unit tests for pure mapping/validation logic. E2E is deferred to gateway+frontend stories.

## Test Scenarios by Acceptance Criteria

### AC1: Resource Server JWT enabled (env/config)

| ID            | Level       | Priority | Test                                                                 | Justification |
| ------------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 16.08-UNIT-001 | Unit        | P1       | Construct `JwtDecoder` bean with issuer-uri set from env             | Pure config bean wiring logic |
| 16.08-INT-001  | Integration | P0       | Valid JWT (correct issuer) accepted; wrong issuer → 401              | Critical security path |
| 16.08-INT-002  | Integration | P0       | Valid JWT using jwk-set-uri path (issuer discovery bypass)           | Env variant support |

### AC2: Route protection policy

| ID            | Level       | Priority | Test                                                     | Justification |
| ------------- | ----------- | -------- | -------------------------------------------------------- | ------------- |
| 16.08-INT-003  | Integration | P0       | `/actuator/health` is public (200)                       | Public health path |
| 16.08-INT-004  | Integration | P0       | `/api/whoami` without token → 401                        | Auth required by default |
| 16.08-INT-005  | Integration | P1       | `/docs/**` access per policy (allow/deny as configured)  | Policy clarity |

### AC3: Role/claim mapping

| ID            | Level       | Priority | Test                                                                 | Justification |
| ------------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 16.08-UNIT-002 | Unit        | P0       | Keycloak realm roles → ROLE_* (user, admin) mapping                  | Prevent privilege errors |
| 16.08-UNIT-003 | Unit        | P0       | Auth0 permissions[] normalize to ROLE_* (read:things → ROLE_READ_THINGS) | Prevent privilege errors |
| 16.08-UNIT-004 | Unit        | P0       | Okta roles[] → ROLE_* normalization                                 | Prevent privilege errors |
| 16.08-INT-006  | Integration | P0       | `/api/admin/ping` with no admin role → 403                            | Authorization boundary |
| 16.08-INT-007  | Integration | P0       | `/api/admin/ping` with admin role → 200                               | Authorization boundary |

### AC4: CORS and headers

| ID            | Level       | Priority | Test                                                                 | Justification |
| ------------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 16.08-INT-008  | Integration | P1       | CORS allows configured `NEXTAUTH_URL` origin in dev/staging          | SPA integration |
| 16.08-INT-009  | Integration | P2       | Random origin is rejected                                            | Hardening |
| 16.08-INT-010  | Integration | P2       | Correlation ID header forwarded; no token echoed                     | Observability + safety |

### AC5: Example endpoints

| ID            | Level       | Priority | Test                                                | Justification |
| ------------- | ----------- | -------- | --------------------------------------------------- | ------------- |
| 16.08-INT-011  | Integration | P1       | `/api/whoami` returns subject (sub) and roles       | Developer diagnostics |
| 16.08-INT-012  | Integration | P1       | `/api/admin/ping` reachable when admin role present | Sanity of admin protection |

### AC6: Configuration hardening

| ID            | Level       | Priority | Test                                                       | Justification |
| ------------- | ----------- | -------- | ---------------------------------------------------------- | ------------- |
| 16.08-INT-013  | Integration | P0       | Wrong audience → 401                                       | Security critical |
| 16.08-INT-014  | Integration | P0       | Expired token → 401; Not-before in future → 401            | Security critical |
| 16.08-INT-015  | Integration | P1       | Clock skew tolerance (±60s) accepted                       | Operational resilience |

### AC7: Documentation

| ID            | Level       | Priority | Test                                            | Justification |
| ------------- | ----------- | -------- | ----------------------------------------------- | ------------- |
| 16.08-UNIT-005 | Unit        | P2       | README contains env vars and curl examples      | Doc lint (simple presence) |

### AC8: Testing

| ID            | Level       | Priority | Test                                                     | Justification |
| ------------- | ----------- | -------- | -------------------------------------------------------- | ------------- |
| 16.08-UNIT-006 | Unit        | P1       | Authorities converter unit tests cover all claim shapes  | Completeness |
| 16.08-INT-016  | Integration | P1       | Integration tests cover 200/401/403 canonical scenarios  | Completeness |

## Risk Coverage
- SEC-101 (issuer/audience validation): 16.08-INT-001/002/013
- SEC-102 (role mapping): 16.08-UNIT-002/003/004, 16.08-INT-006/007
- OPS-101 (JWKS outage/rotation): add resilience tests later with gateway story; basic coverage via 16.08-INT-002
- OPS-102 (clock skew): 16.08-INT-015
- DATA-101 (sensitive logs): verified via code review/static rules (outside this story’s tests)

## Recommended Execution Order
1. P0 Unit: 16.08-UNIT-002/003/004
2. P0 Integration: 16.08-INT-001/002/003/004/006/007/013/014
3. P1 Integration: 16.08-INT-005/011/012/016
4. P1 Unit: 16.08-UNIT-001/006
5. P2 Integration: 16.08-INT-009/010; P2 Unit: 16.08-UNIT-005

## Gate Snippet
```yaml
test_design:
  scenarios_total: 18
  by_level:
    unit: 6
    integration: 12
    e2e: 0
  by_priority:
    p0: 10
    p1: 6
    p2: 2
  coverage_gaps: []
```

## Trace References
- Test design matrix: docs/qa/assessments/16.08-test-design-20250920.md
- P0 tests identified: 10

## Notes
- E2E is intentionally excluded; end-to-end JWT enforcement at the edge will be exercised in the Envoy gateway story. Integration tests here provide sufficient confidence for the backend resource server behavior.
