# Test Design: Story 16.05 — Spring Modulith Configuration

Date: 2025-10-19
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 18
- By level: Unit 5 (28%), Integration 13 (72%), E2E 0 (0%)
- Priority distribution: P0: 8, P1: 8, P2: 2
- Coverage target: ≥80% line and ≥80% branch (JaCoCo gate)
- Scope notes: Backend only; no UI. Prefer fast unit tests first, then integration with Testcontainers PostgreSQL.

## Context Summary

Acceptance Criteria from the story:
1) Transactional outbox: Modulith event publication registry is operational; events persisted atomically to `event_publication` with writes.
2) `event_publication` exists with required indexes; verified by test/inspection.
3) Module boundaries enforced; `ApplicationModules#verify()` passes; no cyclic deps; `.internal` not accessed from other modules.
4) Modulith documentation generated via `Documenter` (overall + per-module PlantUML).
5) Example event published and consumed across two modules via `@ApplicationModuleListener`; idempotency defined.
6) Gradle includes mandatory dependencies; tests use `spring-modulith-starter-test`; CI runs `./gradlew test` and passes.

Risk profile reference: docs/qa/assessments/16.05-risk-20251019.md

## Test Scenarios by Acceptance Criteria

### AC1 — Transactional Outbox Semantics

| ID              | Level       | Priority | Test                                                                 | Justification | Mitigates |
|-----------------|-------------|----------|----------------------------------------------------------------------|---------------|-----------|
| 16.05-INT-001   | Integration | P0       | Publish event inside @Transactional; assert row in `event_publication` | Ensures atomic outbox write | TECH-002, DATA-001 |
| 16.05-INT-002   | Integration | P0       | Rollback service tx (forced exception) → assert no outbox row       | Validates atomicity on rollback | TECH-002 |
| 16.05-UNIT-001  | Unit        | P1       | Publisher service invokes `ApplicationEventPublisher` once           | Fast guard on publish path | TECH-002 |

### AC2 — Table + Indexes Exist

| ID              | Level       | Priority | Test                                                                   | Justification | Mitigates |
|-----------------|-------------|----------|------------------------------------------------------------------------|---------------|-----------|
| 16.05-INT-003   | Integration | P0       | Verify table columns via JDBC metadata/`SELECT`                        | Schema safety | DATA-001 |
| 16.05-INT-004   | Integration | P1       | Verify indexes exist (query pg indexes)                                | Performance readiness | PERF-001 |
| 16.05-INT-005   | Integration | P1       | Profile w/ Modulith auto-DDL vs Flyway fallback; both pass             | Dual creation paths | TECH-003, DATA-001 |

### AC3 — Module Boundaries Enforced

| ID              | Level       | Priority | Test                                                       | Justification | Mitigates |
|-----------------|-------------|----------|------------------------------------------------------------|---------------|-----------|
| 16.05-INT-006   | Integration | P0       | `ApplicationModules.of(...).verify()` passes               | Core boundary check | TECH-001 |
| 16.05-UNIT-002  | Unit        | P1       | ArchUnit rule: forbid access to `..*.internal..` from other modules | Compile-time-ish structural guard | TECH-001 |

### AC4 — Modulith Documentation Generated

| ID              | Level       | Priority | Test                                                              | Justification | Mitigates |
|-----------------|-------------|----------|-------------------------------------------------------------------|---------------|-----------|
| 16.05-INT-007   | Integration | P1       | `Documenter` writes overall PlantUML; assert `build/spring-modulith-docs` exists | Verifies docs | TECH-004 |
| 16.05-INT-008   | Integration | P1       | `Documenter` writes individual module diagrams; assert presence    | Completeness | TECH-004 |

### AC5 — Publish/Consume Across Modules + Idempotency

| ID              | Level       | Priority | Test                                                                 | Justification | Mitigates |
|-----------------|-------------|----------|----------------------------------------------------------------------|---------------|-----------|
| 16.05-INT-009   | Integration | P0       | Publish event; listener in another module handles it (log/side-effect) | Cross-module comms | DATA-002 |
| 16.05-UNIT-003  | Unit        | P0       | Listener idempotency: second call no-op (guard with `processed_events`) | Prevent duplicates | DATA-002 |
| 16.05-INT-010   | Integration | P1       | Duplicate publish → single side-effect; PK on `(event_id, listener_id)` prevents dup | Runtime guard | DATA-002 |
| 16.05-INT-011   | Integration | P1       | CorrelationId flows from request → event → logs                      | Operability | TECH-006 |

### AC6 — Dependencies, Tests, and CI

| ID              | Level       | Priority | Test                                                                  | Justification | Mitigates |
|-----------------|-------------|----------|-----------------------------------------------------------------------|---------------|-----------|
| 16.05-INT-012   | Integration | P0       | Security denies unauthenticated (401) and allows mock JWT (200)       | Default secure posture | SEC-001 |
| 16.05-INT-013   | Integration | P1       | Spring Boot context loads with required beans (smoke)                  | Sanity check | TECH-005, SEC-001 |
| 16.05-INT-014   | Integration | P1       | Coverage gate ≥80% line/branch enforced in CI                         | Non-functional gate | OPS-001 |

## Risk Coverage Mapping

- TECH-001 (boundary failures): 16.05-INT-006, 16.05-UNIT-002
- TECH-002 (non-transactional publish): 16.05-INT-001, 16.05-INT-002, 16.05-UNIT-001
- DATA-001 (schema mismatch): 16.05-INT-003, 16.05-INT-005
- SEC-001 (security posture): 16.05-INT-012, 16.05-INT-013
- DATA-002 (duplicates): 16.05-UNIT-003, 16.05-INT-010
- TECH-004 (doc artifacts): 16.05-INT-007, 16.05-INT-008
- PERF-001 (index perf): 16.05-INT-004
- TECH-005 (annotation order): 16.05-INT-013 (context smoke)
- OPS-001 (CI stability): 16.05-INT-014
- TECH-006 (correlation ID): 16.05-INT-011

## Suite Structure and Naming

- Unit tests (Mockito/AssertJ):
  - `backend/src/test/java/io/monosense/synergyflow/user/BootstrapServiceTests.java` — 16.05-UNIT-001
  - `backend/src/test/java/io/monosense/synergyflow/workflow/BootstrapListenerTests.java` — 16.05-UNIT-003
  - `backend/src/test/java/io/monosense/synergyflow/architecture/ModuleRulesTests.java` (ArchUnit) — 16.05-UNIT-002

- Integration tests (Spring Boot + Testcontainers):
  - `backend/src/test/java/io/monosense/synergyflow/UserEventFlowIT.java` — 16.05-INT-001/002/009/010/011
  - `backend/src/test/java/io/monosense/synergyflow/SchemaVerificationIT.java` — 16.05-INT-003/004/005
  - `backend/src/test/java/io/monosense/synergyflow/ModularityTests.java` — 16.05-INT-006/007/008
  - `backend/src/test/java/io/monosense/synergyflow/SecurityIT.java` — 16.05-INT-012
  - `backend/src/test/java/io/monosense/synergyflow/SmokeContextIT.java` — 16.05-INT-013
  - CI coverage gate — 16.05-INT-014 (Gradle task enforcement)

## Data and Environment

- Use Testcontainers PostgreSQL; disable external DB credentials for tests.
- Flyway migration for `event_publication` only as fallback (IF NOT EXISTS).
- Logback test config includes correlation ID in pattern for assertion.

## Coverage Plan (achieve ≥80% line and branch)

1. Add JaCoCo and branch+line gate:
```kotlin
plugins { jacoco }

tasks.jacocoTestReport { reports { xml.required.set(true); html.required.set(true) } }

tasks.jacocoTestCoverageVerification {
  violationRules {
    rule {
      element = "BUNDLE"
      limit { counter = "LINE"; value = "COVERED_RATIO"; minimum = "0.80".toBigDecimal() }
      limit { counter = "BRANCH"; value = "COVERED_RATIO"; minimum = "0.80".toBigDecimal() }
    }
  }
}

tasks.test { finalizedBy(tasks.jacocoTestReport); dependsOn(tasks.jacocoTestCoverageVerification) }
```
2. Branch coverage focus areas:
- Publisher: success path vs rollback exception.
- Listener: first-time vs duplicate-event branch; error handling.
- Security: unauthorized vs authorized.
- Schema path: auto-DDL vs Flyway fallback profile.

## Recommended Execution Order

1. P0 Unit (UNIT-001, UNIT-003, UNIT-002)
2. P0 Integration (INT-001, INT-002, INT-006, INT-009, INT-012)
3. Remaining P1 Integration (INT-003/004/005/007/008/010/011/013/014)
4. P2 Integration (smoke/doc nuances)

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 18
  by_level:
    unit: 5
    integration: 13
    e2e: 0
  by_priority:
    p0: 8
    p1: 8
    p2: 2
  coverage_gaps: []
```

## Trace References

Test design matrix: docs/qa/assessments/16.05-test-design-20251019.md
P0 tests identified: 8
