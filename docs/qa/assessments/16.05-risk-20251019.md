# Risk Profile: Story 16.05 — Spring Modulith Configuration

Date: 2025-10-19
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 12
- Critical (Score 9): 0
- High (Score 6): 5
- Medium (Score 4): 5
- Low (Score 2–3): 2
- Coverage Target: ≥80% line and ≥80% branch (JaCoCo gate)

Key themes: enforcing module boundaries reliably, ensuring transactional outbox semantics, avoiding duplicate side-effects, securing endpoints by default, and making CI deterministic with Testcontainers and coverage gates.

## Risk Matrix

| Risk ID   | Description                                                                 | Prob | Impact | Score | Priority |
|-----------|------------------------------------------------------------------------------|------|--------|-------|----------|
| TECH-001  | Modulith boundary verification fails due to package layout mistakes         | 2    | 3      | 6     | High     |
| TECH-002  | Event publication not transactional (missing JPA/tx boundaries)             | 2    | 3      | 6     | High     |
| DATA-001  | `event_publication` schema mismatch vs Modulith expectations                 | 2    | 3      | 6     | High     |
| SEC-001   | Resource Server misconfig exposes endpoints                                  | 2    | 3      | 6     | High     |
| DATA-002  | Missing idempotency → duplicate listener side effects                        | 2    | 3      | 6     | High     |
| OPS-001   | CI instability with Testcontainers (network, Docker perms)                   | 2    | 2      | 4     | Medium   |
| TECH-003  | Flyway auto-create conflicts with Modulith auto DDL                          | 2    | 2      | 4     | Medium   |
| TECH-004  | Documenter path changes; artifacts not captured                              | 2    | 2      | 4     | Medium   |
| TECH-005  | Annotation processor order (Lombok/MapStruct) causes build failures          | 2    | 2      | 4     | Medium   |
| PERF-001  | `event_publication` grows without retention; query/index perf degradation    | 2    | 2      | 4     | Medium   |
| OPS-002   | External DB creds inadvertently used in tests instead of Testcontainers      | 1    | 2      | 2     | Low      |
| TECH-006  | Missing correlation ID in logs reduces diagnosability                        | 1    | 2      | 2     | Low      |

Legend: Probability (1=Low, 2=Medium, 3=High). Impact (1=Low, 2=Medium, 3=High). Score=Prob×Impact.

## High-Risk Details and Mitigations

### TECH-001: Modulith boundary verification fails
- Why: Incorrect package roots or `.internal` leakage can break `modules.verify()`.
- Mitigation (preventive): Enforce package template; add `ModularityTests` (present in story). Add negative tests accessing `.internal` types to assert compile-time/package-level boundaries where feasible.
- Testing focus: `ApplicationModules.of(SynergyFlowApplication).verify()`; branch paths for expected vs unexpected module access.

### TECH-002: Event publication not transactional
- Why: Publishing outside `@Transactional` or missing JPA starter prevents atomic outbox.
- Mitigation: Publish inside service method with `@Transactional` (present). Verify row in `event_publication` within the same transaction context in IT.
- Testing focus: IT publishes event and immediately asserts persisted row; simulate rollback path to ensure outbox write is rolled back too.

### DATA-001: `event_publication` schema mismatch
- Why: Divergence between Flyway DDL and Modulith expectations (columns, types, naming).
- Mitigation: Prefer Modulith JPA auto DDL. Only apply Flyway fallback exactly as provided in story. Version the migration uniquely and conditionally (IF NOT EXISTS).
- Testing focus: IT starts with clean container; verify table shape via `SELECT` on expected columns; assert indexes exist.

### SEC-001: Resource Server misconfiguration
- Why: Missing/incorrect JWT wiring leads to unprotected endpoints.
- Mitigation: Minimal `SecurityFilterChain` + application.yaml issuer (present). Add web tests to prove 401 on unauthenticated and 200 with mock JWT.
- Testing focus: `@WebMvcTest` or `@SpringBootTest` with `spring-security-test` using `@WithMockJwt`/mocking to assert deny-by-default.

### DATA-002: Duplicate side-effects (missing idempotency)
- Why: Listener retried or receives duplicate events without `processed_events` check.
- Mitigation: Use `(event_id, listener_id)` PK table; check-before-act. Wrap in transaction.
- Testing focus: Unit test listener called twice → side-effect executed once; IT verifying unique constraint prevents duplicates.

## Medium/Low Risks — Summaries and Actions
- OPS-001: Stabilize CI with Docker socket perms, `testcontainers.reuse.enable=true` locally, and CI caching tweaks. Add retry-once for flaky pulls.
- TECH-003: Guard against duplicate DDL by IF NOT EXISTS; test both auto-created and migration-created scenarios using two IT profiles.
- TECH-004: Lock artifact path in assertions and CI upload glob; fail build if docs dir missing.
- TECH-005: Keep Lombok before MapStruct; include `lombok-mapstruct-binding`. Add a smoke compile test of a mapper to catch regressions.
- PERF-001: Add retention strategy (e.g., job to purge completed entries after N days); ensure covering indexes (already included) and monitor gauge `event_processing_lag_seconds`.
- OPS-002: Ensure tests default to Testcontainers; properties for external DB only for runtime profiles. Add a guard that fails tests if `DB_USERNAME`/`DB_PASSWORD` present.
- TECH-006: Configure logback pattern with `X-Correlation-ID` and add a log assertion in IT.

## Coverage Plan (≥80% line and branch)

1) Enable JaCoCo with branch gate
```kotlin
plugins { jacoco }

tasks.jacocoTestReport { reports { xml.required.set(true); html.required.set(true) } }

tasks.jacocoTestCoverageVerification {
  violationRules {
    rule {
      element = "BUNDLE"
      limit { counter = "LINE"; value = "COVERED_RATIO"; minimum = "0.80".toBigDecimal() }
      limit { counter = "BRANCH"; value = "COVERED_RATIO"; minimum = "0.80".toBigDecimal() }
    }
  }
}

tasks.test { finalizedBy(tasks.jacocoTestReport); dependsOn(tasks.jacocoTestCoverageVerification) }
```

2) Test suite composition and branch targets
- Publisher service: success path, exception path (pre-persist fail), and transaction rollback branch.
- Listener: first-time process vs duplicate-event branch (idempotency); error handling path.
- Security: unauthorized (401), authorized (200) with mock JWT; actuator health (200) open.
- Modulith: happy path `modules.verify()`. Negative compile-time boundaries validated via package visibility and unit tests where applicable.
- DB migration: with/without Modulith auto-DDL profiles.

3) Measurement and CI wiring
- `./gradlew test jacocoTestReport jacocoTestCoverageVerification` in CI.
- Upload artifacts: `backend/build/reports/jacoco/test/html/**` and `backend/build/spring-modulith-docs/**`.

## Test Design Pointers (map to ACs)
- AC1/2/5: IT asserts persisted outbox row and listener execution; duplicate-event branch covered.
- AC3/4: `ModularityTests` plus artifact existence assertion; ensure docs glob uploaded.
- AC6: Build with all deps; security web tests; failing coverage gate fails CI.

## Risk Summary (YAML block for gate file)

```yaml
risk_summary:
  totals:
    critical: 0
    high: 5
    medium: 5
    low: 2
  highest:
    id: TECH-001
    score: 6
    title: Modulith boundary verification fails due to package layout mistakes
  recommendations:
    must_fix:
      - Add JaCoCo 80% line+branch coverage gate and wire to CI
      - Implement idempotency guard with processed_events and test duplicates
      - Enforce deny-by-default security with tests for 401/200 paths
      - Keep Flyway fallback strictly IF NOT EXISTS; test both creation paths
      - Verify `modules.verify()` in CI and fail on boundary violations
    monitor:
      - Track `event_processing_lag_seconds` and outbox growth; add retention job
      - Stabilize Testcontainers in CI (permissions, caching)
```

