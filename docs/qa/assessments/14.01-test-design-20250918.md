# Test Design: Story 14.01 — Test Architecture Scaffolding & Conventions

Date: 2025-09-18
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 18
- Unit tests: 6 (33%)
- Integration tests: 8 (44%)
- E2E tests: 4 (22%)
- Priority distribution: P0: 7, P1: 8, P2: 3

Rationale: Favor integration tests for harnesses and Modulith boundaries, with unit tests for deterministic utilities and lint logic. Limited E2E to CI pipeline flows and end-to-end traceability checks.

## Test Scenarios by Acceptance Criteria

### AC1: Provide project‑wide testing conventions for unit, integration, contract, and E2E tests (naming, structure, fixtures, data seeding)

#### Scenarios

| ID              | Level       | Priority | Test                                                                 | Justification                                       |
| ----------------| ----------- | -------- | -------------------------------------------------------------------- | --------------------------------------------------- |
| 14.01-UNIT-001  | Unit        | P2       | Validate naming regex for test classes and methods                   | Pure validation logic                               |
| 14.01-INT-001   | Integration | P1       | Validate expected test directories/files exist per source-tree       | File system structure and templates                 |
| 14.01-INT-002   | Integration | P1       | Docs linter validates conventions sections are present and linked    | Cross-doc integration (conventions ↔ architecture)  |
| 14.01-E2E-001   | E2E         | P1       | Minimal project executes unit/integration test phases successfully   | End-to-end convention viability in CI               |

### AC2: Create base test utilities: deterministic seeds, Testcontainers harness, event bus harness, API client helpers

#### Scenarios

| ID              | Level       | Priority | Test                                                                 | Justification                                       |
| ----------------| ----------- | -------- | -------------------------------------------------------------------- | --------------------------------------------------- |
| 14.01-UNIT-002  | Unit        | P0       | DeterministicClock returns fixed instants and advances predictably   | Security/compliance of determinism; unit isolated   |
| 14.01-UNIT-003  | Unit        | P1       | Seed generator produces reproducible datasets given seed inputs      | Core utility logic                                  |
| 14.01-INT-003   | Integration | P1       | Postgres/Redis/MinIO/Kafka containers start and are reusable         | Harness integration with infra containers           |
| 14.01-INT-004   | Integration | P0       | Event bus harness captures and asserts PublishedEvents                | Critical for Modulith event validation              |
| 14.01-INT-005   | Integration | P1       | API client helpers perform authenticated calls against stub server   | Component integration (client ↔ server stub)        |
| 14.01-E2E-002   | E2E         | P1       | Full integration suite runs twice with zero flakes                    | End-to-end harness stability                        |

### AC3: Define module test templates for Spring Modulith boundaries with example tests and CI tasks wired

#### Scenarios

| ID              | Level       | Priority | Test                                                                 | Justification                                       |
| ----------------| ----------- | -------- | -------------------------------------------------------------------- | --------------------------------------------------- |
| 14.01-UNIT-004  | Unit        | P2       | Template example tests compile and follow naming/location rules      | Template correctness at unit level                  |
| 14.01-INT-006   | Integration | P0       | ApplicationModules.verify() passes on sample modules                 | Architecture boundary verification                   |
| 14.01-INT-007   | Integration | P1       | @ApplicationModuleTest publishes event and assertion passes          | Modulith isolation example works                    |
| 14.01-E2E-003   | E2E         | P1       | CI executes tasks: test, integrationTest, contractTest, architectureTest | Pipeline flow correctness and reports           |

### AC4: Document Given‑When‑Then authoring guidelines and mapping to TraceLink entities; add lint/check script to CI

#### Scenarios

| ID              | Level       | Priority | Test                                                                 | Justification                                       |
| ----------------| ----------- | -------- | -------------------------------------------------------------------- | --------------------------------------------------- |
| 14.01-UNIT-005  | Unit        | P1       | Trace linter accepts conforming GWT names and rejects nonconforming  | Pure parsing/validation logic                        |
| 14.01-INT-008   | Integration | P0       | Linter resolves TraceLink YAML entries under docs/qa/tracelinks      | Cross-artifact linkage critical for traceability    |
| 14.01-E2E-004   | E2E         | P0       | CI fails build when AC lacks mapped tests in tracelinks              | Compliance gate for traceability                    |

### AC5: Introduce flakiness mitigation patterns: isolation, time control, retries with diagnostics; CI reports include flaky test detection

#### Scenarios

| ID              | Level       | Priority | Test                                                                 | Justification                                       |
| ----------------| ----------- | -------- | -------------------------------------------------------------------- | --------------------------------------------------- |
| 14.01-UNIT-006  | Unit        | P1       | Retry policy triggers only once and records diagnostics              | Core policy logic                                   |
| 14.01-INT-009   | Integration | P0       | Induced flake is detected; report generated at build/reports/tests/flaky | Critical CI stability gate                      |
| 14.01-INT-010   | Integration | P1       | DeterministicClock eliminates time-based flakiness in sample tests   | Risk mitigation validation                          |

## Risk Coverage

- OPS-001 (CI flakiness): 14.01-INT-009, 14.01-E2E-002, 14.01-E2E-003
- DATA-001 (Determinism): 14.01-UNIT-002, 14.01-INT-010
- SEC-001 (Secrets in logs): Covered implicitly via CI checks and log hygiene in pipeline; add follow-up test in Story 14.03
- PERF-001 (Startup overhead): Observed via E2E timings in 14.01-E2E-002; optimization tracked in Epic 16
- TECH-001 (Modulith misuse): 14.01-INT-006, 14.01-INT-007
- BUS-002 (Under-enforced gates): 14.01-E2E-003, 14.01-E2E-004

## Recommended Execution Order

1. P0 Unit/Integration: 14.01-UNIT-002, 14.01-INT-004, 14.01-INT-006, 14.01-INT-008, 14.01-INT-009
2. P0 E2E: 14.01-E2E-004
3. P1 Unit/Integration/E2E: remaining P1 scenarios (seed reproducibility, API helpers, pipeline execution)
4. P2 scenarios last (template compile, naming regex)

---

```yaml
test_design:
  scenarios_total: 18
  by_level:
    unit: 6
    integration: 8
    e2e: 4
  by_priority:
    p0: 7
    p1: 8
    p2: 3
  coverage_gaps: []
```

Trace references:

Test design matrix: docs/qa/assessments/14.01-test-design-20250918.md
P0 tests identified: 7

Quality checklist:

- [x] Every AC has test coverage
- [x] Test levels appropriate
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk
- [x] Test IDs follow naming convention
- [x] Scenarios are atomic and independent

