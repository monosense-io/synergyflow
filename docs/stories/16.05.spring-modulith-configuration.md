# Story 16.05: Spring Modulith Configuration

## Status

Approved

## Story

**As a** platform engineer,
**I want** Spring Modulith configured with verified module boundaries and a persistent event publication registry,
**so that** all backend modules communicate reliably via in‑JVM events with at‑least‑once delivery and enforced architectural boundaries.

## Acceptance Criteria

1. Spring Modulith event publication registry is operational with transactional outbox semantics; events are persisted to `event_publication` atomically with writes. [Source: docs/prd/epics/02-foundation-phase-epics-months-1-4.md; docs/architecture/2-high-level-architecture.md; docs/architecture/11-backend-architecture.md]
2. `event_publication` table exists at runtime with required indexes; verified by integration test and/or DB inspection. [Source: docs/prd/epics/02-foundation-phase-epics-months-1-4.md; docs/architecture/9-database-schema.md]
3. Module boundaries enforced: `ApplicationModules#verify()` passes in `ModularityTests` (no cyclic deps; `.internal` not accessed from other modules). [Source: docs/architecture/16-coding-standards.md; docs/architecture/33-mandatory-backend-code-templates-conventions.md]
4. Modulith documentation generated via `Documenter` (PlantUML for overall and per‑module diagrams). Artifacts produced in build output. [Source: docs/architecture/33-mandatory-backend-code-templates-conventions.md]
5. Example event published and consumed across two modules using `@ApplicationModuleListener`; listener runs and idempotency pattern is defined for future use. [Source: docs/architecture/11-backend-architecture.md; docs/architecture/33-mandatory-backend-code-templates-conventions.md]
6. Gradle includes mandatory Modulith, Lombok, MapStruct dependencies; tests use `spring-modulith-starter-test`. CI runs `./gradlew test` and passes. [Source: docs/architecture/33-mandatory-backend-code-templates-conventions.md]

## Tasks / Subtasks

- [ ] Gradle and Tooling Setup (AC: 6)
  - [ ] Add dependencies to `backend/build.gradle.kts`: `spring-modulith-starter-core`, `spring-modulith-starter-jpa`, `spring-modulith-starter-test`, Lombok, MapStruct, SpringDoc. [Source: docs/architecture/33-mandatory-backend-code-templates-conventions.md#331-gradle-dependencies-configuration-mandatory]
  - [ ] Ensure `tasks.withType<Test> { useJUnitPlatform() }` configured. [Source: docs/architecture/33-mandatory-backend-code-templates-conventions.md#331-gradle-dependencies-configuration-mandatory]
  - [ ] Add `backend/lombok.config` with required settings. [Source: docs/architecture/33-mandatory-backend-code-templates-conventions.md#322-lombok-configuration-mandatory]
  - [ ] Add JaCoCo coverage gate (≥80% line and branch) and wire to CI (P0 from QA plan):
    ```kotlin
    // backend/build.gradle.kts (JaCoCo)
    plugins { jacoco }

    tasks.jacocoTestReport { reports { xml.required.set(true); html.required.set(true) } }

    tasks.jacocoTestCoverageVerification {
      violationRules {
        rule {
          element = "BUNDLE"
          limit { counter = "LINE"; value = "COVERED_RATIO"; minimum = "0.80".toBigDecimal() }
          limit { counter = "BRANCH"; value = "COVERED_RATIO"; minimum = "0.80".toBigDecimal() }
        }
      }
    }

    tasks.test {
      finalizedBy(tasks.jacocoTestReport)
      dependsOn(tasks.jacocoTestCoverageVerification)
    }
    ```
  - [ ] Inline Gradle snippet (self-contained):
    ```kotlin
    // backend/build.gradle.kts (snippet)
    dependencies {
        // Spring Boot & Modulith
        implementation("org.springframework.boot:spring-boot-starter-data-jpa")
        implementation("org.springframework.boot:spring-boot-starter-web")
        implementation("org.springframework.boot:spring-boot-starter-validation")
        implementation("org.springframework.boot:spring-boot-starter-security")
        implementation("org.springframework.boot:spring-boot-starter-oauth2-resource-server")
        implementation("org.springframework.modulith:spring-modulith-starter-core")
        implementation("org.springframework.modulith:spring-modulith-starter-jpa")

        // Database / Migrations
        runtimeOnly("org.postgresql:postgresql")
        implementation("org.flywaydb:flyway-core")

        // Lombok (before MapStruct)
        compileOnly("org.projectlombok:lombok:1.18.30")
        annotationProcessor("org.projectlombok:lombok:1.18.30")

        // MapStruct (after Lombok)
        implementation("org.mapstruct:mapstruct:1.5.5.Final")
        annotationProcessor("org.mapstruct:mapstruct-processor:1.5.5.Final")
        annotationProcessor("org.projectlombok:lombok-mapstruct-binding:0.2.0")

        // OpenAPI
        implementation("org.springdoc:springdoc-openapi-starter-webmvc-ui:2.3.0")

        // Optional platform libs used in this project
        implementation("org.flowable:flowable-spring-boot-starter:7.1.0")
        implementation("io.github.resilience4j:resilience4j-spring-boot3:2.1.0")

        testImplementation("org.springframework.boot:spring-boot-starter-test")
        testImplementation("org.springframework.modulith:spring-modulith-starter-test")
        testImplementation("org.springframework.security:spring-security-test")
        testCompileOnly("org.projectlombok:lombok:1.18.30")
        testAnnotationProcessor("org.projectlombok:lombok:1.18.30")
        testAnnotationProcessor("org.mapstruct:mapstruct-processor:1.5.5.Final")
    }

    tasks.withType<Test> { useJUnitPlatform() }
    ```
  - [ ] Inline Lombok config (self-contained):
    ```properties
    # backend/lombok.config
    lombok.addLombokGeneratedAnnotation = true
    lombok.copyableAnnotations += org.springframework.beans.factory.annotation.Qualifier
    lombok.copyableAnnotations += org.springframework.beans.factory.annotation.Value
    lombok.copyableAnnotations += org.springframework.context.annotation.Lazy
    config.stopBubbling = true
    ```

- [ ] Annotate and Structure Application (AC: 3)
  - [ ] Ensure `SynergyFlowApplication` uses `@SpringBootApplication` and Modulith setup as per architecture; package root `io.monosense.synergyflow`. [Source: docs/architecture/2-high-level-architecture.md]
  - [ ] Create initial modules `incident`, `change`, `user`, `workflow`, `policy`, each with `.internal` subpackage for entities/repos/impl; public API at module root (DTOs, Service interfaces, events). [Source: docs/architecture/2-high-level-architecture.md; docs/architecture/16-coding-standards.md]
  - [ ] Add `commons` module marked OPEN via `package-info.java` if needed. [Source: docs/architecture/2-high-level-architecture.md]
  - [ ] Example package layout (clarity):
    - `io.monosense.synergyflow.user` (public DTOs/services/events)
    - `io.monosense.synergyflow.user.internal` (entities/repos/impl/listeners)
    - `io.monosense.synergyflow.workflow` (public API)
    - `io.monosense.synergyflow.workflow.internal` (listeners/impl)

- [ ] Event Publication Registry Enablement (AC: 1,2,5)
  - [ ] Implement sample domain event record `BootstrapVerifiedEvent` at a module root (e.g., `user`). [Source: docs/architecture/11-backend-architecture.md]
  - [ ] Publish the event inside a transactional service method (e.g., during a simple bootstrap write) using `ApplicationEventPublisher`. [Source: docs/architecture/11-backend-architecture.md#service-layer-with-event-publishing]
  - [ ] Create a consumer in a different module (e.g., `workflow.internal`) using `@ApplicationModuleListener`; include comments for idempotency via `processed_events` pattern. [Source: docs/architecture/33-mandatory-backend-code-templates-conventions.md#3213-event-listener-template-mandatory-spring-modulith]
  - [ ] Verify event persisted to `event_publication` and listener invoked in logs/tests; capture correlationId in logs. [Source: docs/architecture/4-data-models.md#47-eventpublication-spring-modulith; docs/architecture/16-coding-standards.md#critical-fullstack-rules]
  - [ ] Minimal example (publisher + listener):
    ```java
    // backend/src/main/java/io/monosense/synergyflow/user/BootstrapVerifiedEvent.java
    package io.monosense.synergyflow.user;
    import java.util.UUID;
    public record BootstrapVerifiedEvent(UUID id, UUID correlationId) {}

    // backend/src/main/java/io/monosense/synergyflow/user/internal/BootstrapService.java
    package io.monosense.synergyflow.user.internal;
    import io.monosense.synergyflow.user.BootstrapVerifiedEvent;
    import org.springframework.context.ApplicationEventPublisher;
    import org.springframework.stereotype.Service;
    import org.springframework.transaction.annotation.Transactional;
    import java.util.UUID;

    @Service
    class BootstrapService {
        private final ApplicationEventPublisher events;
        BootstrapService(ApplicationEventPublisher events) { this.events = events; }

        @Transactional
        void publishBootstrap(UUID id, UUID correlationId) {
            // persist domain change here (repository.save(...))
            events.publishEvent(new BootstrapVerifiedEvent(id, correlationId));
            // Spring Modulith JPA starter persists to event_publication atomically
        }
    }

    // backend/src/main/java/io/monosense/synergyflow/workflow/internal/BootstrapListener.java
    package io.monosense.synergyflow.workflow.internal;
    import io.monosense.synergyflow.user.BootstrapVerifiedEvent;
    import org.springframework.modulith.events.ApplicationModuleListener;
    import org.slf4j.Logger; import org.slf4j.LoggerFactory;
    import org.springframework.stereotype.Component;

    @Component
    class BootstrapListener {
        private static final Logger log = LoggerFactory.getLogger(BootstrapListener.class);

        @ApplicationModuleListener
        void on(BootstrapVerifiedEvent evt) {
            // Idempotency: ensure (evt.id, listener_id) not in processed_events before side effects
            // INSERT INTO processed_events(event_id, listener_id) VALUES (evt.id(), 'workflow.BootstrapListener');
            log.info("Handled BootstrapVerifiedEvent id={} corrId={}", evt.id(), evt.correlationId());
        }
    }
    ```

- [ ] Database Verification (AC: 2)
  - [ ] With `spring-modulith-starter-jpa`, verify `event_publication` table is created and indexed at runtime; if not auto‑created, add Flyway migration using DDL in docs. [Source: docs/architecture/9-database-schema.md#92-core-tables]
  - [ ] Flyway fallback DDL (self-contained) — create `backend/src/main/resources/db/migration/V0001__event_publication.sql`:
    ```sql
    -- Spring Modulith transactional outbox
    CREATE TABLE IF NOT EXISTS event_publication (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        event_type VARCHAR(255) NOT NULL,
        aggregate_id UUID NOT NULL,
        event_data JSONB NOT NULL,
        published_at TIMESTAMP NOT NULL DEFAULT NOW(),
        completed_at TIMESTAMP,
        listener_id VARCHAR(255),
        retry_count INTEGER NOT NULL DEFAULT 0,
        correlation_id UUID NOT NULL,
        causation_id UUID
    );
    CREATE INDEX IF NOT EXISTS idx_event_publication_aggregate_id ON event_publication(aggregate_id);
    CREATE INDEX IF NOT EXISTS idx_event_publication_event_type ON event_publication(event_type);
    CREATE INDEX IF NOT EXISTS idx_event_publication_completed_at ON event_publication(completed_at);
    CREATE INDEX IF NOT EXISTS idx_event_publication_published_at ON event_publication(published_at DESC);

    -- Idempotency helper (optional, for listeners)
    CREATE TABLE IF NOT EXISTS processed_events (
        event_id UUID NOT NULL,
        listener_id VARCHAR(255) NOT NULL,
        processed_at TIMESTAMP NOT NULL DEFAULT NOW(),
        PRIMARY KEY (event_id, listener_id)
    );
    ```

- [ ] Modulith Verification + Docs (AC: 3,4)
  - [ ] Add `ModularityTests` that constructs `ApplicationModules.of(SynergyFlowApplication.class)` and calls `modules.verify()`. [Source: docs/architecture/33-mandatory-backend-code-templates-conventions.md#spring-modulith-verification-test-mandatory]
  - [ ] In the same test class, call `new Documenter(modules).writeModulesAsPlantUml().writeIndividualModulesAsPlantUml()` and assert files exist. [Source: docs/architecture/33-mandatory-backend-code-templates-conventions.md#spring-modulith-verification-test-mandatory]
  - [ ] Minimal test example and artifact path:
    ```java
    // backend/src/test/java/io/monosense/synergyflow/ModularityTests.java
    package io.monosense.synergyflow;
    import org.junit.jupiter.api.Test;
    import org.springframework.modulith.core.ApplicationModules;
    import org.springframework.modulith.docs.Documenter;
    import java.nio.file.*;
    import static org.junit.jupiter.api.Assertions.*;

    class ModularityTests {
        @Test void verifyModulesAndGenerateDocs() {
            ApplicationModules modules = ApplicationModules.of(SynergyFlowApplication.class);
            modules.verify();
            new Documenter(modules).writeModulesAsPlantUml().writeIndividualModulesAsPlantUml();
            assertTrue(Files.exists(Path.of("build/spring-modulith-docs")));
        }
    }
    ```
  - [ ] CI: Upload artifact path `backend/build/spring-modulith-docs/**/*` after tests.
  - [ ] CI: Upload coverage report `backend/build/reports/jacoco/test/html/**` for review.

- [ ] Security + Standards Alignment (AC: 6)
  - [ ] Ensure Spring Security Resource Server baseline compiles with JWT; endpoints protected by default. [Source: docs/architecture/11-backend-architecture.md#security-configuration]
  - [ ] Confirm package naming rules and Lombok/MapStruct use per standards. [Source: docs/architecture/16-coding-standards.md]
  - [ ] Minimal security configuration and properties:
    ```java
    // backend/src/main/java/io/monosense/synergyflow/SecurityConfig.java
    package io.monosense.synergyflow;
    import org.springframework.context.annotation.*;
    import org.springframework.security.config.annotation.web.builders.HttpSecurity;
    import org.springframework.security.web.SecurityFilterChain;

    @Configuration
    class SecurityConfig {
        @Bean
        SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
            return http
                .csrf(csrf -> csrf.disable())
                .authorizeHttpRequests(auth -> auth
                    .requestMatchers("/actuator/health").permitAll()
                    .anyRequest().authenticated())
                .oauth2ResourceServer(oauth2 -> oauth2.jwt())
                .build();
        }
    }
    ```
    ```yaml
    # backend/src/main/resources/application.yaml (snippet)
    spring:
      security:
        oauth2:
          resourceserver:
            jwt:
              issuer-uri: ${OAUTH2_ISSUER_URI}
    ```

- [ ] Tests (AC: 1,2,3,4,5,6)
  - [ ] Unit tests for the publisher service (Mockito for repo interactions) and listener behavior (idempotency path). [Source: docs/architecture/14-testing-strategy.md#backend-testing]
  - [ ] Integration test (Spring Boot + Testcontainers PostgreSQL) that publishes the sample event and verifies `event_publication` contains a row and listener runs. [Source: docs/architecture/14-testing-strategy.md#integration-test-spring-modulith--testcontainers; docs/architecture/9-database-schema.md]
  - [ ] Modulith verification test (`modules.verify()` + docs generation). [Source: docs/architecture/33-mandatory-backend-code-templates-conventions.md]
  - [ ] Canonical test classes and assertions (for discoverability):
    - `backend/src/test/java/io/monosense/synergyflow/ModularityTests.java` — asserts docs dir exists and `modules.verify()` passes.
    - `backend/src/test/java/io/monosense/synergyflow/user/BootstrapServiceTests.java` — unit tests publisher with Mockito; verifies `ApplicationEventPublisher` invoked once.
    - `backend/src/test/java/io/monosense/synergyflow/workflow/BootstrapListenerTests.java` — unit tests listener idempotency branch (simulated processed_events lookup).
    - `backend/src/test/java/io/monosense/synergyflow/user/UserEventFlowIT.java` — Testcontainers PostgreSQL; publishes event; queries `event_publication` has row; asserts listener side-effect/log line.
  - [ ] Enforce JaCoCo gate ≥80% line and branch in CI; fail build if unmet.
  - [ ] Reference QA assets for detailed scenarios and risks:
    - Risk profile: `docs/qa/assessments/16.05-risk-20251019.md`
    - Test design: `docs/qa/assessments/16.05-test-design-20251019.md`

## Dev Notes

- Architecture Principles
  - Modular monolith with Spring Modulith; events are Java records; in‑JVM bus with transactional outbox. [Source: docs/architecture/2-high-level-architecture.md]
  - EventPublication data model and indexes described; rely on Modulith JPA starter or Flyway fallback. [Source: docs/architecture/4-data-models.md#47-eventpublication-spring-modulith; docs/architecture/9-database-schema.md#92-core-tables]

- Required Dependencies and Config
  - Gradle entries for Modulith, Lombok, MapStruct, SpringDoc, Flowable, Resilience4j; JUnit platform. [Source: docs/architecture/33-mandatory-backend-code-templates-conventions.md#331-gradle-dependencies-configuration-mandatory]
  - Security baseline via OAuth2 Resource Server; protect `/api/v1/**`. [Source: docs/architecture/11-backend-architecture.md#security-configuration]

- Module Layout and Boundaries
  - Public API at module root (DTOs, Services, Events); internal package contains Entities, Repos, Mappers, ServiceImpl, Listeners. [Source: docs/architecture/16-coding-standards.md#package-boundary-enforcement-spring-modulith]
  - `commons` module OPEN only for cross‑cutting concerns (e.g., exception handlers, config). [Source: docs/architecture/2-high-level-architecture.md]

- Verification & Docs
  - `ApplicationModules#verify()` must pass; PlantUML diagrams generated as build artifacts. [Source: docs/architecture/33-mandatory-backend-code-templates-conventions.md#spring-modulith-verification-test-mandatory]

#### Preconditions & Config

- Database connectivity available (PgBouncer pooler + `synergyflow` DB). [Source: docs/prd/epics/02-foundation-phase-epics-months-1-4.md]
- Spring Boot properties (local and CI):
  - `spring.datasource.url=jdbc:postgresql://synergyflow-pooler-rw.cnpg-system.svc.cluster.local:5432/synergyflow`
  - `spring.datasource.username=${DB_USERNAME}`
  - `spring.datasource.password=${DB_PASSWORD}`
  - `spring.jpa.hibernate.ddl-auto=validate`
  - Note: If `event_publication` is not auto-created by Modulith JPA starter, create it via Flyway using the DDL defined in docs. [Source: docs/architecture/9-database-schema.md#92-core-tables]
- CI secrets configured: `DB_USERNAME`, `DB_PASSWORD` scoped to dev environment.
- Correlation ID propagation enabled (HTTP filter adds/propagates `X-Correlation-ID` → MDC). [Source: docs/architecture/16-coding-standards.md#16.1-critical-fullstack-rules]
  - Example logback pattern (nice-to-have):
    ```xml
    <pattern>%d{yyyy-MM-dd'T'HH:mm:ss.SSSX} %-5level [%X{X-Correlation-ID}] %logger{36} - %msg%n</pattern>
    ```
- Tests MUST use Testcontainers PostgreSQL; ensure external `DB_USERNAME`/`DB_PASSWORD` are not used by test profile to avoid flakiness.

#### Artifacts Produced

- Modulith diagrams: `backend/build/spring-modulith-docs/` (PlantUML overall + per-module). [Source: docs/architecture/33-mandatory-backend-code-templates-conventions.md]
- Test evidence: Integration test that writes and queries `event_publication`; logs show listener handling with `correlationId`.
- CI artifacts: Upload `backend/build/spring-modulith-docs/**` on successful build.
- Coverage artifacts: Upload `backend/build/reports/jacoco/test/html/**`; gate must pass ≥80% line/branch.

#### Definition of Ready (Dependencies)

- OPS lane Story 16.10 (PgBouncer + DB + schemas) available in dev environment.
- Gradle toolchain and Modulith dependencies present (see Tasks section). [Source: docs/architecture/33-mandatory-backend-code-templates-conventions.md]

#### Exit Checks (Done Criteria)

1. `modules.verify()` passes with no violations.
2. At least one event is published; a row exists in `event_publication` for the sample event.
3. Listener executes (log line with `correlationId` observed) and idempotency pattern documented.
4. PlantUML diagrams generated at `backend/build/spring-modulith-docs/` and uploaded as CI artifacts.
5. JaCoCo coverage gate passes with ≥80% line and ≥80% branch in CI.

### Testing

- Backend Unit Tests: ≥80% coverage for publisher and listener logic; verify correlationId propagation. [Source: docs/architecture/14-testing-strategy.md#backend-testing]
- Integration Test: Testcontainers PostgreSQL; publish sample event; assert row in `event_publication` and listener side-effects/logs. [Source: docs/architecture/14-testing-strategy.md#integration-test-spring-modulith--testcontainers; docs/architecture/9-database-schema.md]
- Modulith Tests: `modules.verify()` and documentation generation. [Source: docs/architecture/33-mandatory-backend-code-templates-conventions.md]
 - QA-Driven Plan: Follow scenarios and priorities in `docs/qa/assessments/16.05-test-design-20251019.md`; ensure risks in `docs/qa/assessments/16.05-risk-20251019.md` are mitigated via tests called out there (TECH-001/002, DATA-001/002, SEC-001, etc.).
 - Coverage Gate: Enforce JaCoCo branch+line ≥80% as configured in Gradle.

## Change Log

| Date       | Version | Description                                       | Author |
|------------|---------|---------------------------------------------------|--------|
| 2025-10-18 | v0.1    | Initial draft for Spring Modulith configuration  | Sarah  |
| 2025-10-19 | v0.2    | Course corrections: inline Gradle/Lombok snippets; minimal Modulith test; event publisher/listener example; Flyway DDL; security baseline; concrete tests and CI artifact path; logging pattern note | Sarah  |
| 2025-10-19 | v0.3    | Integrated QA risk and test design: added JaCoCo gate, CI coverage artifacts, Testcontainers-only guidance, Testing section references, and exit check for ≥80% line/branch | Sarah  |
| 2025-10-19 | v0.4    | Status flipped to Approved                       | Sarah  |

## Dev Agent Record

- Agent Model Used: 
- Debug Log References: 
- Completion Notes List: 
- File List: 

## QA Results

- Pending QA review.
